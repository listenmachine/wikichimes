<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wiki Chimes</title>
  <style>
    :root { --pink:#ff4da6; --white:#ffffff; }

    html, body { height: 100%; }
    body{
      margin: 24px;
      max-width: 860px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--pink);
      color: var(--white);
    }

    h1{ margin: 0 0 14px; font-size: 22px; font-weight: 700; }

    .top{
      display: flex;
      gap: 14px;
      align-items: center;
      margin-bottom: 14px;
    }

    button{
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      background: transparent;
      color: var(--white);
      border: 2px solid var(--white);
      font-weight: 700;
    }
    button[disabled]{ opacity: 0.6; cursor: not-allowed; }

    .status{
      font-size: 13px;
      opacity: 1;
    }

    #asciiChimes{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 14px;
      line-height: 1.05;
      padding: 14px 16px;
      border: 2px solid var(--white);
      border-radius: 14px;
      white-space: pre;
      user-select: none;
      margin: 12px 0 14px;
      overflow: hidden;
    }

    ul{
      list-style: none;
      padding: 0;
      margin: 0;
      border: 2px solid var(--white);
      border-radius: 14px;
      overflow: hidden;
    }
    li{
      padding: 10px 12px;
      border-top: 2px solid var(--white);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: baseline;
    }
    li:first-child{ border-top: 0; }

    a{
      color: var(--white);
      text-decoration: none;
    }
    a:hover{ text-decoration: underline; }

    .meta{
      font-size: 12px;
      white-space: nowrap;
    }
    .sub{
      font-size: 12px;
      margin-top: 2px;
    }
  </style>
</head>

<body>
  <h1>Wiki Chimes</h1>

  <div class="top">
    <button id="toggle">Start</button>
    <div class="status" id="status">stopped</div>
  </div>

  <pre id="asciiChimes" aria-label="Wind chimes animation"></pre>

  <ul id="feed" aria-label="Live edits list"></ul>

<script>
(() => {
  const STREAM_URL = "https://stream.wikimedia.org/v2/stream/recentchange";

  // Keep it listenable. Set to "" for all wikis.
  const DEFAULT_DOMAIN = "en.wikipedia.org";

  const toggleBtn = document.getElementById("toggle");
  const statusEl  = document.getElementById("status");
  const feedEl    = document.getElementById("feed");
  const chimesEl  = document.getElementById("asciiChimes");

  let es = null;
  let running = false;

  // Soft density limiter (still allows overlap)
  const recentChimes = [];
  const MAX_CHIMES_PER_SEC = 10;

  // --- Audio ---
  let audio = null;

  function makeImpulseResponse(ctx, seconds = 5.0, decay = 4.6) {
    const rate = ctx.sampleRate;
    const length = Math.floor(rate * seconds);
    const impulse = ctx.createBuffer(2, length, rate);
    for (let ch = 0; ch < 2; ch++) {
      const data = impulse.getChannelData(ch);
      for (let i = 0; i < length; i++) {
        const t = i / length;
        const env = Math.pow(1 - t, decay);
        data[i] = (Math.random() * 2 - 1) * env;
      }
    }
    return impulse;
  }

  function ensureAudio() {
    if (audio) return audio;

    const ctx = new (window.AudioContext || window.webkitAudioContext)();

    const input = ctx.createGain();

    const hpf = ctx.createBiquadFilter();
    hpf.type = "highpass";
    hpf.frequency.value = 120;

    const lpf = ctx.createBiquadFilter();
    lpf.type = "lowpass";
    lpf.frequency.value = 12000;

    const preDelay = ctx.createDelay(0.25);
    preDelay.delayTime.value = 0.06;

    const convolver = ctx.createConvolver();
    convolver.buffer = makeImpulseResponse(ctx, 5.0, 4.6);

    const wetLPF = ctx.createBiquadFilter();
    wetLPF.type = "lowpass";
    wetLPF.frequency.value = 6500;

    const wet = ctx.createGain();
    wet.gain.value = 0.62;

    const dry = ctx.createGain();
    dry.gain.value = 0.72;

    const master = ctx.createGain();
    master.gain.value = 0.36;

    const comp = ctx.createDynamicsCompressor();
    comp.threshold.value = -20;
    comp.knee.value = 22;
    comp.ratio.value = 7;
    comp.attack.value = 0.004;
    comp.release.value = 0.22;

    input.connect(hpf).connect(lpf);

    // dry
    lpf.connect(dry).connect(master);

    // wet
    lpf.connect(preDelay);
    preDelay.connect(convolver);
    convolver.connect(wetLPF).connect(wet).connect(master);

    master.connect(comp).connect(ctx.destination);

    audio = { ctx, input };
    return audio;
  }

  function hash32(str) {
    let h = 2166136261 >>> 0;
    for (let i = 0; i < str.length; i++) {
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  // Wind-chime-friendly tuning: G major pentatonic (G A B D E)
  const SCALE = [392.00, 440.00, 493.88, 587.33, 659.25];

  function playChime(f0, strength = 0.6) {
    const { ctx, input } = ensureAudio();
    const now = ctx.currentTime;

    // Modal partials: closer to “tube” than a normal harmonic synth
    const ratios = [1.00, 2.01, 2.76, 3.90, 5.41, 8.93];
    const gains  = [1.00, 0.40, 0.32, 0.22, 0.14, 0.10];

    const voice = ctx.createGain();
    const amp = ctx.createGain();
    const pan = ctx.createStereoPanner();

    pan.pan.value = (Math.random() * 0.6 - 0.3);

    amp.gain.setValueAtTime(0.0001, now);
    amp.gain.exponentialRampToValueAtTime(0.80 * strength, now + 0.010);
    amp.gain.exponentialRampToValueAtTime(0.0001, now + 3.1);

    voice.connect(amp).connect(pan).connect(input);

    for (let i = 0; i < ratios.length; i++) {
      const baseFreq = f0 * ratios[i];

      // Pair of close sines for shimmer
      for (let p = 0; p < 2; p++) {
        const o = ctx.createOscillator();
        o.type = "sine";
        o.frequency.value = baseFreq * (p === 0 ? 1.0 : 1.0 + (Math.random() * 0.004));

        const g = ctx.createGain();
        g.gain.setValueAtTime(0.0001, now);
        g.gain.exponentialRampToValueAtTime(gains[i] * strength * (p === 0 ? 1 : 0.85), now + 0.008);

        const tail = 2.6 - i * 0.28;
        g.gain.exponentialRampToValueAtTime(0.0001, now + Math.max(0.70, tail));

        o.connect(g).connect(voice);
        o.start(now);
        o.stop(now + 3.3);
      }
    }

    // Tiny “clink” strike
    const noiseBuf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * 0.04), ctx.sampleRate);
    const d = noiseBuf.getChannelData(0);
    for (let i = 0; i < d.length; i++) {
      const t = i / d.length;
      d[i] = (Math.random() * 2 - 1) * (1 - t);
    }

    const noise = ctx.createBufferSource();
    noise.buffer = noiseBuf;

    const nHPF = ctx.createBiquadFilter();
    nHPF.type = "highpass";
    nHPF.frequency.value = 900;

    const nGain = ctx.createGain();
    nGain.gain.setValueAtTime(0.0001, now);
    nGain.gain.exponentialRampToValueAtTime(0.10 * strength, now + 0.004);
    nGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.06);

    noise.connect(nHPF).connect(nGain).connect(voice);
    noise.start(now);
    noise.stop(now + 0.07);
  }

  // --- Feed / events ---
  function matchesFilters(ev) {
    if (!ev) return false;
    if (ev?.meta?.domain === "canary") return false;
    if (typeof ev.type === "string" && ev.type !== "edit") return false;
    if (DEFAULT_DOMAIN && ev.server_name !== DEFAULT_DOMAIN) return false;
    if (typeof ev.namespace === "number" && ev.namespace !== 0) return false;
    if (ev.bot === true) return false;
    return true;
  }

  function toPageUrl(ev) {
    if (ev?.meta?.uri) return ev.meta.uri;
    const domain = ev?.server_name || DEFAULT_DOMAIN || "en.wikipedia.org";
    const title = ev?.title || "";
    return `https://${domain}/wiki/${encodeURIComponent(title.replace(/ /g, "_"))}`;
  }

  function addToFeed(ev) {
    const li = document.createElement("li");

    const left = document.createElement("div");
    const right = document.createElement("div");
    right.className = "meta";

    const a = document.createElement("a");
    a.href = toPageUrl(ev);
    a.target = "_blank";
    a.rel = "noopener noreferrer";
    a.textContent = ev.title || "(untitled)";

    const sub = document.createElement("div");
    sub.className = "sub";
    sub.textContent = ev.user ? ev.user : "unknown";

    const when = (typeof ev.timestamp === "number")
      ? new Date(ev.timestamp * 1000).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" })
      : "";

    right.textContent = when;

    left.appendChild(a);
    left.appendChild(sub);

    li.appendChild(left);
    li.appendChild(right);

    feedEl.prepend(li);
    while (feedEl.children.length > 60) feedEl.removeChild(feedEl.lastChild);
  }

  // --- ASCII chimes animation (simplified, classic silhouette) ---
  let chimeImpulse = 0;
  function nudgeChimes(amount = 1) {
    chimeImpulse = Math.min(9, chimeImpulse + amount);
  }

  function buildChimesFrame(tMs) {
    const width = 64;
    const height = 18;

    const t = tMs * 0.0016;

    // Gentle sway; impulse gives a bigger swing for a moment
    const amp = 1.0 + chimeImpulse * 0.9;
    const sway = Math.round(Math.sin(t) * amp * 0.35); // global sway
    const cx = Math.floor(width / 2) + sway;

    const grid = Array.from({ length: height }, () => Array(width).fill(" "));
    const set = (x, y, ch) => {
      if (x < 0 || x >= width || y < 0 || y >= height) return;
      grid[y][x] = ch;
    };
    const put = (x, y, s) => {
      for (let i = 0; i < s.length; i++) set(x + i, y, s[i]);
    };

    // Top ring + hanger
    put(cx - 3, 0, "  ___ ");
    put(cx - 3, 1, " /   \\");
    put(cx - 3, 2, " \\___/");
    set(cx, 3, "|");
    set(cx, 4, "|");

    // Bar
    put(cx - 16, 5, "+------------------------------+");
    put(cx - 16, 6, "| o  o  o  o  o  o  o  o  o   |");
    put(cx - 16, 7, "+------------------------------+");

    // Tube anchors under some of the o's
    const anchors = [cx - 13, cx - 9, cx - 5, cx - 1, cx + 3, cx + 7, cx + 11];
    const localT = tMs * 0.0019;

    // Central clapper/striker position
    const clSway = Math.round(Math.sin(localT * 1.2 + 0.7) * amp * 0.18);
    const clx = cx + clSway;

    for (let i = 0; i < anchors.length; i++) {
      // each tube gets a slightly different phase, but stays coherent
      const phase = i * 0.55;
      const tubeSway = Math.round(Math.sin(localT + phase) * amp * 0.22);

      const ax = anchors[i];
      const x = ax + tubeSway;

      // string (simple, readable)
      // show a tiny angle at the bar if it’s swaying
      const dx = x - ax;
      set(ax, 8, dx > 0 ? "\\" : dx < 0 ? "/" : "|");
      set(x, 9, "|");

      // tube
      const tubeLen = 4 + (i % 3); // 4..6
      for (let k = 0; k < tubeLen; k++) put(x - 1, 10 + k, "||");
      put(x - 1, 10 + tubeLen, "[]");
    }

    // clapper string + clapper
    set(cx, 8, "|");
    set(clx, 9, "|");
    put(clx - 1, 12, "()");
    set(clx, 13, "|");
    set(clx, 14, "|");

    // light wind marker
    const gust = Math.round((Math.sin(t * 0.9) + 1) * 8);
    put(2, 16, "~".repeat(gust));

    return grid.map(row => row.join("")).join("\n");
  }

  function animateChimes(tMs) {
    // keep it simple: no extra colours, no effects
    chimeImpulse *= 0.92;
    if (chimeImpulse < 0.02) chimeImpulse = 0;

    chimesEl.textContent = buildChimesFrame(tMs);
    requestAnimationFrame(animateChimes);
  }
  requestAnimationFrame(animateChimes);

  // --- Chime trigger ---
  function chimeForEvent(ev) {
    const title = ev?.title || "unknown";
    const user  = ev?.user  || "unknown";

    const hT = hash32(title);
    const hU = hash32(user);

    const base = SCALE[hT % SCALE.length];
    const octave = (hU % 3);
    const freq = base * Math.pow(2, octave);

    let strength = 0.55;
    if (typeof ev.length === "object" && typeof ev.length.new === "number" && typeof ev.length.old === "number") {
      const delta = Math.min(2000, Math.abs(ev.length.new - ev.length.old));
      strength = 0.35 + (delta / 2000) * 0.60;
    }

    const nowMs = performance.now();
    recentChimes.push(nowMs);
    while (recentChimes.length && (nowMs - recentChimes[0] > 1000)) recentChimes.shift();

    if (recentChimes.length <= MAX_CHIMES_PER_SEC) {
      playChime(freq, strength);
      nudgeChimes(0.7 + strength * 1.8);
    } else {
      nudgeChimes(0.25);
    }
  }

  function setStatus(text) { statusEl.textContent = text; }

  function start() {
    const { ctx } = ensureAudio();
    ctx.resume();

    if (es) es.close();
    es = new EventSource(STREAM_URL);

    setStatus("connecting…");
    toggleBtn.textContent = "Stop";
    running = true;

    es.onopen = () => setStatus(`listening (${DEFAULT_DOMAIN || "all wikis"})`);
    es.onerror = () => setStatus("connection error (retrying…)");

    es.onmessage = (msg) => {
      let ev;
      try { ev = JSON.parse(msg.data); } catch { return; }
      if (!matchesFilters(ev)) return;

      chimeForEvent(ev);
      addToFeed(ev);
    };
  }

  function stop() {
    if (es) { es.close(); es = null; }
    setStatus("stopped");
    toggleBtn.textContent = "Start";
    running = false;
  }

  toggleBtn.addEventListener("click", () => {
    if (!running) start();
    else stop();
  });
})();
</script>
</body>
</html>
