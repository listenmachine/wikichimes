<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wiki Chimes</title>
  <style>
    :root { color-scheme: light dark; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 24px;
      max-width: 820px;
    }
    h1{ margin: 0 0 14px; font-size: 22px; }
    .top{
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 14px;
    }
    button{
      padding: 10px 14px;
      border: 0;
      border-radius: 12px;
      cursor: pointer;
      background: #111;
      color: #fff;
      font-weight: 600;
    }
    button[disabled]{ opacity: 0.6; cursor: not-allowed; }
    .status{
      font-size: 13px;
      opacity: 0.75;
    }

    #asciiChimes{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 14px;
      line-height: 1.05;
      padding: 14px 16px;
      border: 1px solid #ddd;
      border-radius: 14px;
      background: rgba(127,127,127,0.06);
      overflow: hidden;
      user-select: none;
      margin: 12px 0 14px;
      white-space: pre;
    }

    ul{
      list-style: none;
      padding: 0;
      margin: 0;
      border: 1px solid #ddd;
      border-radius: 14px;
      overflow: hidden;
    }
    li{
      padding: 10px 12px;
      border-top: 1px solid rgba(127,127,127,0.18);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: baseline;
      background: rgba(127,127,127,0.03);
    }
    li:first-child{ border-top: 0; }
    a{
      text-decoration: none;
    }
    a:hover{ text-decoration: underline; }
    .meta{
      font-size: 12px;
      opacity: 0.72;
      white-space: nowrap;
    }
    .sub{
      font-size: 12px;
      opacity: 0.7;
      margin-top: 2px;
    }
  </style>
</head>

<body>
  <h1>Wiki Chimes</h1>

  <div class="top">
    <button id="toggle">Start</button>
    <div class="status" id="status">stopped</div>
  </div>

  <pre id="asciiChimes" aria-label="Wind chimes animation"></pre>

  <ul id="feed" aria-label="Live edits list"></ul>

<script>
(() => {
  // Wikimedia recent changes firehose (SSE)
  const STREAM_URL = "https://stream.wikimedia.org/v2/stream/recentchange";

  // Keep this conservative so it’s listenable.
  // You can change to "" to allow all wikis.
  const DEFAULT_DOMAIN = "en.wikipedia.org";

  const toggleBtn = document.getElementById("toggle");
  const statusEl  = document.getElementById("status");
  const feedEl    = document.getElementById("feed");
  const chimesEl  = document.getElementById("asciiChimes");

  let es = null;
  let running = false;

  // --- soft audio limiter (keeps overlap, prevents total chaos) ---
  const recentChimes = []; // timestamps (ms) of played chimes
  const MAX_CHIMES_PER_SEC = 12;

  // --- Audio ---
  let audio = null;

  function makeImpulseResponse(ctx, seconds = 2.2, decay = 3.5) {
    const rate = ctx.sampleRate;
    const length = Math.floor(rate * seconds);
    const impulse = ctx.createBuffer(2, length, rate);
    for (let ch = 0; ch < 2; ch++) {
      const data = impulse.getChannelData(ch);
      for (let i = 0; i < length; i++) {
        const t = i / length;
        const env = Math.pow(1 - t, decay);
        data[i] = (Math.random() * 2 - 1) * env;
      }
    }
    return impulse;
  }

  function ensureAudio() {
    if (audio) return audio;

    const ctx = new (window.AudioContext || window.webkitAudioContext)();

    const input = ctx.createGain();

    const hpf = ctx.createBiquadFilter();
    hpf.type = "highpass";
    hpf.frequency.value = 120;

    const lpf = ctx.createBiquadFilter();
    lpf.type = "lowpass";
    lpf.frequency.value = 12000;

    const convolver = ctx.createConvolver();
    convolver.buffer = makeImpulseResponse(ctx, 2.4, 3.2);

    const wet = ctx.createGain();
    wet.gain.value = 0.28;

    const dry = ctx.createGain();
    dry.gain.value = 0.92;

    const master = ctx.createGain();
    master.gain.value = 0.38;

    const comp = ctx.createDynamicsCompressor();
    comp.threshold.value = -18;
    comp.knee.value = 18;
    comp.ratio.value = 6;
    comp.attack.value = 0.003;
    comp.release.value = 0.18;

    // routing
    input.connect(hpf).connect(lpf);
    lpf.connect(dry).connect(master);
    lpf.connect(convolver);
    convolver.connect(wet).connect(master);

    master.connect(comp).connect(ctx.destination);

    audio = { ctx, input, master };
    return audio;
  }

  // Simple stable hash for mapping titles/users to notes
  function hash32(str) {
    let h = 2166136261 >>> 0;
    for (let i = 0; i < str.length; i++) {
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  function playChime(f0, strength = 0.6) {
    const { ctx, input } = ensureAudio();
    const now = ctx.currentTime;

    // Inharmonic partials (bar/tube-ish)
    const ratios = [1.0, 2.756, 5.404, 8.933, 13.343];
    const gains  = [1.0, 0.55, 0.32, 0.20, 0.12];

    const detuneCents = (Math.random() * 10 - 5);

    const voice = ctx.createGain();
    const amp = ctx.createGain();
    const pan = ctx.createStereoPanner();

    pan.pan.value = (Math.random() * 0.6 - 0.3);

    amp.gain.setValueAtTime(0.0001, now);
    amp.gain.exponentialRampToValueAtTime(0.85 * strength, now + 0.008);
    amp.gain.exponentialRampToValueAtTime(0.0001, now + 2.2);

    voice.connect(amp).connect(pan).connect(input);

    for (let i = 0; i < ratios.length; i++) {
      const o = ctx.createOscillator();
      o.type = "sine";
      o.frequency.value = f0 * ratios[i];
      o.detune.value = detuneCents;

      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(gains[i] * strength, now + 0.006);

      // Higher partials die sooner
      const tail = 1.65 - i * 0.18;
      g.gain.exponentialRampToValueAtTime(0.0001, now + Math.max(0.55, tail));

      o.connect(g).connect(voice);
      o.start(now);
      o.stop(now + 2.4);
    }

    // Soft strike noise
    const noiseBuf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * 0.03), ctx.sampleRate);
    const d = noiseBuf.getChannelData(0);
    for (let i = 0; i < d.length; i++) d[i] = (Math.random() * 2 - 1) * (1 - i / d.length);

    const noise = ctx.createBufferSource();
    noise.buffer = noiseBuf;

    const nGain = ctx.createGain();
    nGain.gain.setValueAtTime(0.0001, now);
    nGain.gain.exponentialRampToValueAtTime(0.12 * strength, now + 0.002);
    nGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.03);

    noise.connect(nGain).connect(voice);
    noise.start(now);
    noise.stop(now + 0.04);
  }

  function chimeForEvent(ev) {
    // Pentatonic-ish; title selects pitch, user selects octave
    const scale = [261.63, 293.66, 329.63, 392.00, 440.00]; // C D E G A
    const title = ev?.title || "unknown";
    const user  = ev?.user  || "unknown";

    const hT = hash32(title);
    const hU = hash32(user);

    const base = scale[hT % scale.length];
    const octave = (hU % 3); // 0..2
    const freq = base * Math.pow(2, octave);

    let strength = 0.55;
    if (typeof ev.length === "object" && typeof ev.length.new === "number" && typeof ev.length.old === "number") {
      const delta = Math.min(2000, Math.abs(ev.length.new - ev.length.old));
      strength = 0.35 + (delta / 2000) * 0.55;
    }

    // Soft limiter: keep overlap, but cap total density.
    const nowMs = performance.now();
    recentChimes.push(nowMs);
    while (recentChimes.length && (nowMs - recentChimes[0] > 1000)) recentChimes.shift();
    if (recentChimes.length <= MAX_CHIMES_PER_SEC) {
      playChime(freq, strength);
      nudgeChimes(0.6 + strength * 1.6);
    } else {
      // Still give a tiny animation tick so the page feels alive.
      nudgeChimes(0.25);
    }
  }

  function matchesFilters(ev) {
    if (!ev) return false;

    // ignore test/canary events
    if (ev?.meta?.domain === "canary") return false;

    // keep it to actual edits (ignore log events etc.)
    if (typeof ev.type === "string" && ev.type !== "edit") return false;

    // safe default: one wiki domain
    if (DEFAULT_DOMAIN && ev.server_name !== DEFAULT_DOMAIN) return false;

    // articles only (namespace 0)
    if (typeof ev.namespace === "number" && ev.namespace !== 0) return false;

    // hide bot edits
    if (ev.bot === true) return false;

    return true;
  }

  function toPageUrl(ev) {
    // Prefer meta.uri if present; otherwise construct
    if (ev?.meta?.uri) return ev.meta.uri;
    const domain = ev?.server_name || DEFAULT_DOMAIN || "en.wikipedia.org";
    const title = ev?.title || "";
    return `https://${domain}/wiki/${encodeURIComponent(title.replace(/ /g, "_"))}`;
  }

  function addToFeed(ev) {
    const li = document.createElement("li");

    const left = document.createElement("div");
    const right = document.createElement("div");
    right.className = "meta";

    const a = document.createElement("a");
    a.href = toPageUrl(ev);
    a.target = "_blank";
    a.rel = "noopener noreferrer";
    a.textContent = ev.title || "(untitled)";

    const sub = document.createElement("div");
    sub.className = "sub";
    const who = ev.user ? ev.user : "unknown";
    const when = (typeof ev.timestamp === "number")
      ? new Date(ev.timestamp * 1000).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" })
      : "";
    sub.textContent = `${who}`;

    left.appendChild(a);
    left.appendChild(sub);

    right.textContent = when;

    li.appendChild(left);
    li.appendChild(right);

    feedEl.prepend(li);

    // cap list length
    while (feedEl.children.length > 60) feedEl.removeChild(feedEl.lastChild);
  }

  function setStatus(text) {
    statusEl.textContent = text;
  }

  function start() {
    const { ctx } = ensureAudio();
    ctx.resume();

    if (es) es.close();
    es = new EventSource(STREAM_URL);

    setStatus("connecting…");
    toggleBtn.textContent = "Stop";
    running = true;

    es.onopen = () => setStatus(`listening (${DEFAULT_DOMAIN || "all wikis"})`);
    es.onerror = () => setStatus("connection error (retrying…)");

    es.onmessage = (msg) => {
      let ev;
      try { ev = JSON.parse(msg.data); } catch { return; }
      if (!matchesFilters(ev)) return;

      chimeForEvent(ev);
      addToFeed(ev);
    };
  }

  function stop() {
    if (es) { es.close(); es = null; }
    setStatus("stopped");
    toggleBtn.textContent = "Start";
    running = false;
  }

  toggleBtn.addEventListener("click", () => {
    if (!running) start();
    else stop();
  });

  // --- ASCII wind chimes animation ---
  let chimeImpulse = 0;

  function nudgeChimes(amount = 1) {
    chimeImpulse = Math.min(8, chimeImpulse + amount);
  }

  function buildChimesFrame(tMs) {
    const width = 54;
    const height = 14;

    const base = 0.9;
    const amp = base + chimeImpulse;
    const t = tMs * 0.002;

    const grid = Array.from({ length: height }, () => Array(width).fill(" "));

    function put(x, y, s) {
      if (y < 0 || y >= height) return;
      for (let i = 0; i < s.length; i++) {
        const xx = x + i;
        if (xx >= 0 && xx < width) grid[y][xx] = s[i];
      }
    }

    put(14, 0, ".------------------------.");
    put(14, 1, "|  o  o  o  o  o  o      |");
    put(14, 2, "'------------------------'");

    const anchors = [18, 21, 24, 27, 30, 33];

    for (let i = 0; i < anchors.length; i++) {
      const phase = i * 0.85;
      const sway = Math.round(Math.sin(t + phase) * amp * 0.35);

      const x = anchors[i] + sway;

      put(x, 3, "|");
      put(x, 4, "|");

      const tubeLen = 3 + (i % 3);
      for (let k = 0; k < tubeLen; k++) put(x - 1, 5 + k, "||");

      put(x, 5 + tubeLen, "v");
    }

    const gust = Math.round((Math.sin(t * 0.7) + 1) * 8);
    put(2, 10, "wind: " + "~".repeat(gust));

    return grid.map(row => row.join("")).join("\n");
  }

  function animateChimes(tMs) {
    if (window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
      chimesEl.textContent = buildChimesFrame(0);
      return;
    }
    chimeImpulse *= 0.92;
    if (chimeImpulse < 0.02) chimeImpulse = 0;

    chimesEl.textContent = buildChimesFrame(tMs);
    requestAnimationFrame(animateChimes);
  }
  requestAnimationFrame(animateChimes);

})();
</script>
</body>
</html>
